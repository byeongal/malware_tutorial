import pefile

# AhnLab-V3 : Trojan/Win32.WannaCryptor.R200571
# ALYac : Trojan.Ransom.WannaCryptor
file_path = r"./samples/84c82835a5d21bbcf75a61706d8ab549.vir"

pe = pefile.PE(file_path)

array = []
library = []
libdict = {}

for entry in pe.DIRECTORY_ENTRY_IMPORT:
    dll = entry.dll.decode('ascii')
    for imp in entry.imports:
        address = imp.address
        try:
            function = imp.name.decode('ascii')
        except:
            function = str(imp.name)
        else:
            pass

        if dll not in library:
            library.append(dll)
        array.append({"library": dll, "offset": address, "function": function })

for key in library:
    libdict[key] = []

for lib in library:
    for item in array:
        if lib == item['library']:
            libdict[lib].append({"offset": item['offset'], "function": item['function']})

for key, value in sorted(libdict.items(), key = lambda x : x[0]):
    print(key)
    for each in sorted(value, key = lambda x : x['offset']):
        print('0x{:08X} {}'.format(each['offset'], each['function']))