import pefile
import capstone

# AhnLab-V3 : Trojan/Win32.WannaCryptor.R200571
# ALYac : Trojan.Ransom.WannaCryptor
file_path = r"./samples/84c82835a5d21bbcf75a61706d8ab549.vir"

pe = pefile.PE(file_path)
dis = capstone.Cs(capstone.CS_ARCH_X86, capstone.CS_MODE_32)

def is_executable(characteristics):
    if characteristics & 0x20 == 0x20 and characteristics & 0x20000000 == 0x20000000:
        return True
    else:
        return False

for section in pe.sections:
    if is_executable(section.Characteristics):
        try:
            section_name = str(section.Name, 'utf-8').encode('ascii', errors='ignore').strip().decode('ascii')
        except:
            section_name = str(section.Name, 'ISO-8859-1').encode('ascii', errors='ignore').strip().decode('ascii')
        section_name = section_name.replace('\u0000', '')
        print('{:08x} <{}>:'.format(section.PointerToRawData + pe.OPTIONAL_HEADER.ImageBase, section_name))
        for code_line in dis.disasm(section.get_data(), 0x1000):
            print('\t{:08x}:\t{}\t{}\t{}'.format(
                code_line.address + pe.OPTIONAL_HEADER.ImageBase,
                ' '.join(['{:02x}'.format(each_byte) for each_byte in code_line.bytes]).ljust(17),
                '{}'.format(code_line.mnemonic).strip(),
                '{}'.format(code_line.op_str).strip()
            ))